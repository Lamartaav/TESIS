
---
title: "PDL1 LUSC Plots de Violin - HIF1A, SLC2A1, SLC16A3, LDHA, CA9"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
  pdf_document: default
params:
  url_tsv: "https://raw.githubusercontent.com/Lamartaav/TESIS/refs/heads/main/tejido_tumoral.tsv"

---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


```{r, echo=FALSE, message = FALSE, results='hide'}
suppressPackageStartupMessages({
  library(readr)
  library(dplyr)
  library(stringr)
  library(tidyr)
  library(ggplot2)
  library(knitr)
})
```


```{r, echo=FALSE, message = FALSE, results='hide'}
url_tsv <- params$url_tsv

tabla <- read.delim(url_tsv, check.names = FALSE, stringsAsFactors = FALSE)

# Identificar columnas núcleo y de muestras
core_cols <- c("gene-id", "gene-name", "gene-type")

is_tumor_sample <- function(colname) {
  if (is.na(colname) || !is.character(colname)) return(FALSE)
  if (!startsWith(colname, "TCGA-")) return(FALSE)
  parts <- strsplit(colname, "-", fixed = TRUE)[[1]]
  if (length(parts) < 4) return(FALSE)
  token4 <- parts[4]
  if (nchar(token4) < 2) return(FALSE)
  yy <- substr(token4, 1, 2)
  if (!grepl("^[0-9]{2}$", yy)) return(FALSE)
  as.integer(yy) >= 1 && as.integer(yy) <= 9
}

sample_cols <- names(tabla)[vapply(names(tabla), is_tumor_sample, logical(1))]
length(sample_cols)
```



```{r, echo=FALSE, message = FALSE, results='hide'}
keep_cols <- c(core_cols, sample_cols)
df_tumor <- tabla[, keep_cols]

# Revisión rápida
cat("Muestras tumorales detectadas:", length(sample_cols), "de", ncol(tabla) - length(core_cols), "columnas de muestras totales.\n")
```
# CD274
```{r, echo=FALSE, message = FALSE, results='hide'}
# Tomar la(s) fila(s) con gene-name == "CD274"
cd274_rows <- dplyr::filter(df_tumor, `gene-name` == "CD274")
if (nrow(cd274_rows) == 0) stop("No se encontró el gen CD274 en 'gene-name'.")
if (nrow(cd274_rows) > 1) {
  message(sprintf("Aviso: se encontraron %d filas para CD274; se usa la primera (gene-id=%s).",
                  nrow(cd274_rows), cd274_rows$`gene-id`[1]))
}
cd274_row <- cd274_rows[1, ]

# Valores crudos FPKM-UQ de CD274 en las muestras tumorales
cd274_vals <- suppressWarnings(as.numeric(unlist(cd274_row[, sample_cols], use.names = FALSE)))
cd274_vals <- cd274_vals[!is.na(cd274_vals)]

CD274_MED <- stats::median(cd274_vals, na.rm = TRUE)

cat("Mediana CD274 (FPKM-UQ, tumor):", signif(CD274_MED, 6), "\n")
```

## Definición de grupos (CD274 low / high)


```{r, echo=FALSE, message = FALSE}
# Serie con nombres de columna = sample barcodes
cd274_series <- suppressWarnings(as.numeric(unlist(cd274_row[, sample_cols], use.names = FALSE)))
names(cd274_series) <- sample_cols

barcode_to_patient <- function(x) {
  ifelse(is.na(x), NA_character_,
         vapply(strsplit(x, "-", fixed = TRUE), function(z) {
           if (length(z) >= 3) paste(z[1:3], collapse = "-") else NA_character_
         }, character(1)))
}

cd274_df <- tibble::tibble(
  sample_id  = names(cd274_series),
  patient_id = barcode_to_patient(names(cd274_series)),
  cd274_val  = as.numeric(cd274_series),
  cd274_grp  = dplyr::case_when(
    cd274_val < CD274_MED  ~ "Low",
    cd274_val > CD274_MED  ~ "High",
    TRUE                   ~ NA_character_   # EXACTAMENTE igual a la mediana => sin grupo
  )
)

# (Opcional) Si querés incluir los empates en High (o Low), reemplazá la línea anterior por:
# cd274_grp = ifelse(cd274_val >= CD274_MED, "High", "Low")


# Resumen de tamaños
cd274_df %>%
  dplyr::count(cd274_grp, name = "n_muestras") %>%
  print()
```


```{r, echo=FALSE, message = FALSE}
# --- LECTURA DEL CLINICAL (URL RAW DIRECTA) + FILTRO LUSC ---
url_clinical <- "https://raw.githubusercontent.com/Lamartaav/TESIS/main/clinical_unido.tsv"

clinical <- read.delim(url_clinical, check.names = FALSE, stringsAsFactors = FALSE) %>%
  dplyr::filter(project.project_id == "TCGA-LUSC")

# ⚠️ NO volver a redefinir barcode_to_patient ni cd274_df aquí (ya existen arriba)

# --- Stage mapping robusto (convierte valores raros y '--' a NA) ---
stage_to_group <- function(x) {
  if (is.na(x) || !nzchar(x)) return(NA_character_)
  s <- toupper(trimws(x))
  if (s %in% c("--", "[NOT AVAILABLE]", "[NOT APPLICABLE]", "[NOT EVALUATED]", "[PENDING]")) {
    return(NA_character_)
  }
  s <- gsub("^STAGE\\s*", "", s)
  s <- gsub("\\(.*?\\)", "", s)
  s <- gsub("[^A-Z0-9 ]", " ", s)
  s <- gsub("\\s+", " ", s)

  m <- regexpr("\\b(IV|III|II|I|4|3|2|1)\\b", s, perl = TRUE)
  if (m[1] == -1) return(NA_character_)
  token <- regmatches(s, m)

  if (token %in% c("I", "II", "1", "2"))   return("Early")
  if (token %in% c("III", "IV", "3", "4")) return("Advance")
  NA_character_
}

# Quedarnos con ID y estadio, y calcular StageGroup
clinical_min <- clinical %>%
  dplyr::select(`cases.submitter_id`, `diagnoses.ajcc_pathologic_stage`) %>%
  dplyr::rename(
    patient_id = `cases.submitter_id`,
    ajcc_stage = `diagnoses.ajcc_pathologic_stage`
  ) %>%
  dplyr::mutate(StageGroup = vapply(ajcc_stage, stage_to_group, character(1)))

# Join final (usa cd274_df DEFINIDO POR MEDIANA más arriba)
expr_design <- cd274_df %>%
  dplyr::left_join(clinical_min, by = "patient_id") %>%
  dplyr::filter(!is.na(StageGroup), !is.na(cd274_grp)) %>%
  dplyr::mutate(
    StageGroup = factor(StageGroup, levels = c("Early", "Advance")),
    cd274_grp  = factor(cd274_grp,  levels = c("Low", "High"))
  )

# Resumen
expr_design %>% dplyr::count(StageGroup, cd274_grp, name = "n") %>% print()

```


```{r, echo=FALSE, message = FALSE, results='hide'}

# --- Lista de genes a comparar (puedes cambiarla libremente) ---
genes_target <- c("HIF1A","SLC2A1","SLC16A3","LDHA","CA9","PDK1")

# Función auxiliar: obtiene un data.frame largo con (sample_id, expr, gene)
get_gene_long <- function(gene_symbol, df_expr, sample_cols) {
  gene_rows <- dplyr::filter(df_expr, `gene-name` == gene_symbol)
  if (nrow(gene_rows) == 0) return(NULL)

  # Si hay duplicados del gen, usamos la primera fila como en CD274
  gene_row <- gene_rows[1, sample_cols, drop = FALSE]
  vals <- suppressWarnings(as.numeric(unlist(gene_row, use.names = FALSE)))

  tibble::tibble(
    sample_id = sample_cols,
    expr      = vals,
    gene      = gene_symbol
  ) |>
    dplyr::filter(!is.na(expr))
}

# Construir una tabla larga con todos los genes solicitados
gene_long_list <- lapply(genes_target, get_gene_long, df_expr = df_tumor, sample_cols = sample_cols)
gene_long <- dplyr::bind_rows(gene_long_list)

# Unir con diseño (StageGroup + CD274 group) y quedarnos solo con muestras con Stage & CD274 definidos
plot_df <- gene_long |>
  dplyr::inner_join(expr_design, by = "sample_id") |>
  dplyr::select(gene, sample_id, expr, cd274_grp, StageGroup)

# Chequeo de conteos por gen/estrato
plot_df |>
  dplyr::count(gene, StageGroup, cd274_grp) |>
  print()
```


```{r, echo=FALSE, message = FALSE, results='hide'}
# Paleta simple similar a tu figura (verde para Low, rojo para High)
scale_fill_cd274 <- scale_fill_manual(values = c("Low" = "#55A868", "High" = "#C44E52"))

plot_violin_by_stage <- function(df, gene_symbol) {
  df_g <- dplyr::filter(df, gene == gene_symbol)
  if (nrow(df_g) == 0) {
    message("No hay datos para ", gene_symbol)
    return(NULL)
  }

  p <- ggplot(df_g, aes(x = cd274_grp, y = expr, fill = cd274_grp)) +
    geom_violin(trim = FALSE, alpha = 0.85) +
    geom_boxplot(width = 0.15, outlier.shape = NA) +
    facet_wrap(~ StageGroup, nrow = 1, drop = TRUE) +
    scale_fill_cd274 +
    labs(
      title = gene_symbol,
      x = "CD274 group",
      y = "Expresión (FPKM-UQ)"
    ) +
    theme_bw(base_size = 12) +
    theme(
      legend.position = "none",
      strip.background = element_rect(fill = "grey92", colour = NA),
      panel.grid.minor = element_blank()
    )

  # p-values (Wilcoxon) con tu equivalencia: * p<0.05, ** p<0.01, *** p<0.001
  if (requireNamespace("ggpubr", quietly = TRUE)) {
    p <- p + ggpubr::stat_compare_means(
      aes(group = cd274_grp),
      method = "wilcox.test",
      label = "p.signif",
      comparisons = list(c("Low", "High")),
      hide.ns = TRUE,
      symnum.args = list(
        cutpoints = c(0, 0.001, 0.01, 0.05, 1),
        symbols   = c("***", "**", "*", "ns")
      )
    )
  }

  p
}

# Dibujar uno por uno (como paneles separados)
plots <- lapply(genes_target, function(g) plot_violin_by_stage(plot_df, g))
for (pp in plots) if (!is.null(pp)) print(pp)
```
