---
title: "Expresión de Genes: Tejido Normal vs. Tejido Tumoral"
output: 
  html_document:
    toc: true        # <- Esto activa la tabla de contenido
    toc_depth: 3     # <- Nivel de títulos que se mostrarán (opcional)
    toc_float: false  # <- Hace que el índice flote (opcional)
date: "Índice"
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(survival)
library(survminer)
library(dplyr)
library(tidyverse)
library(ggrepel)
library(scales)
library(ggplot2)
library(plotly)
library(dplyr)
library(tidyr)
library(ggsignif)
library(rstatix)

```

```{r, include=FALSE, cache=TRUE, warning=FALSE}

interseccion_tumoral_normal <- read.delim("https://raw.githubusercontent.com/Lamartaav/TESIS/refs/heads/main/interseccion_tumoral_normal.tsv")

```

# Expresión de Genes en Tejido Tumoral vs Tejido Normal Adyacente

Expresión de genes de interés: "SLC2A1",  "SLC16A1", "SLC16A3","CA9", "HIF1A", "LDHA", "FOXP3", "CD274", "EPAS1", "HK2", "PKM", "GPI", "ALDOA", "PGK1", "PGM1", "ENO1".

N = 89.

Se muestra su respectivo p valor. 


```{r, echo=FALSE, cache=TRUE, warning=FALSE, fig.width=12, fig.height=12, fig.show='hold'}

## ============================
## Tumor vs Normal: gráficos por gen (PNG)
## Requiere: interseccion_tumoral_normal.rda  (objeto: interseccion_tumoral_normal)
## ============================

# Paquetes (descomenta para instalar si falta alguno)
# install.packages(c("dplyr","tidyr","ggplot2"))

suppressPackageStartupMessages({
  library(dplyr)
  library(tidyr)
  library(ggplot2)
})

## 1) Cargar datos
df <- as.data.frame(interseccion_tumoral_normal)

meta <- c("gene.name","gene.id","gene.type")
stopifnot(all(meta %in% names(df)))
sample_cols <- setdiff(names(df), meta)

## 2) Clasificar Tumor vs Normal por YY (dos dígitos después del participant ID)
get_yy <- function(x) {
  m <- regexec("TCGA[-_.][^-_.]+[-_.][^-_.]+[-_.]([0-9]{2})", x, perl = TRUE, ignore.case = TRUE)
  regmatches(x, m) |>
    lapply(function(z) if (length(z) >= 2) z[2] else NA_character_) |>
    unlist()
}
yy <- get_yy(sample_cols)
yy_num <- suppressWarnings(as.integer(yy))
group <- ifelse(!is.na(yy_num) & yy_num >=  1 & yy_num <=  9, "Tumor",
         ifelse(!is.na(yy_num) & yy_num >= 10 & yy_num <= 19, "Normal", NA_character_))
keep <- !is.na(group)
sample_cols <- sample_cols[keep]
group <- group[keep]

## 3) Genes a graficar (PD-L1=CD274, GLUT1=SLC2A1)
genes_req <- c("SLC2A1",  "SLC16A1", "SLC16A3","CA9", "HIF1A", "LDHA", "FOXP3", "CD274", "EPAS1", "HK2", "PKM", "GPI", "ALDOA", "PGK1", "PGM1", "ENO1")

## 4) Pasar a formato largo y etiquetar
long <- df |>
  dplyr::filter(.data[["gene.name"]] %in% genes_req) |>
  tidyr::pivot_longer(all_of(sample_cols), names_to = "sample", values_to = "expr") |>
  dplyr::left_join(data.frame(sample = sample_cols, group = group), by = "sample") |>
  dplyr::filter(!is.na(group)) |>
  dplyr::mutate(
    gene_label = dplyr::case_when(
      `gene.name` == "CD274"  ~ "PD-L1 (CD274)",
      `gene.name` == "SLC2A1" ~ "GLUT1 (SLC2A1)",
      TRUE ~ `gene.name`
    ),
    group = factor(group, levels = c("Normal","Tumor"))
  )

## 5) Carpeta de salida
outdir <- "plots_tumor_vs_normal"
if (!dir.exists(outdir)) dir.create(outdir)

## 6) Estilo y colores
pal <- c(Normal = "#6BA8A9", Tumor = "#E07A5F")
base_theme <- theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.04),
    axis.title.x = element_blank(),
    axis.title.y = element_text(face = "bold"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "none"
  )

## 7) Formateo de p-values (reemplaza a ggpubr)
format_pval <- function(p) {
  if (is.na(p)) return("NA")
  if (p < 2.2e-16) "< 2e-16"
  else if (p < 1e-3) formatC(p, format = "e", digits = 2)
  else signif(p, 3)
}

## 8) Loop por gen: calcula p y guarda un PNG por gen
for (g in unique(long$gene_label)) {
  dat_g <- dplyr::filter(long, gene_label == g)

  # p‑value (Wilcoxon por defecto; cambia a t.test si querés)
  pv <- wilcox.test(expr ~ group, data = dat_g)$p.value
  pv_lab <- format_pval(pv)

  ymax  <- max(dat_g$expr, na.rm = TRUE)
  y_top <- ymax + 0.08 * ymax  # espacio para el p-value

  p <- ggplot(dat_g, aes(x = group, y = expr, fill = group)) +
    geom_violin(width = 0.92, alpha = 0.10, color = NA, trim = FALSE) +
    geom_boxplot(width = 0.30, outlier.shape = NA, alpha = 0.35, color = "grey25") +
    geom_jitter(aes(color = group), width = 0.12, size = 1.3, alpha = 0.55) +
    scale_fill_manual(values = pal) +
    scale_color_manual(values = pal) +
    scale_y_continuous(expand = expansion(mult = c(0.02, 0.14))) +
    labs(title = paste0("Expresión génica: ", g), y = "Expresión (FPKM_UQ_UNSTRANDED)") +
    base_theme +
    annotate("text", x = 1.5, y = y_top, label = paste0("pValue = ", pv_lab),
             size = 4.2, fontface = "bold")
  print(p)
  
}

```

