---
title: "Correlaciones de genes (Pearson) - LUSC - Todos los Estadios"
output:
  html_document:
    toc: true
    toc_float: true
    theme: readable
    df_print: paged
---

# LUSC - Todos los estadios

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE)

library(survival)
library(survminer)
library(dplyr)
library(tidyverse)
library(ggrepel)
library(scales)
library(ggplot2)
library(plotly)
library(dplyr)
library(tidyr)
library(ggsignif)
library(rstatix)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE)

need <- function(pkgs){
  miss <- pkgs[!sapply(pkgs, requireNamespace, quietly = TRUE)]
  if(length(miss)) install.packages(miss)
  invisible(lapply(pkgs, library, character.only = TRUE))
}
need(c("tidyverse","GGally","ggplot2","rlang"))
```

```{r, include=FALSE}
# Leer directamente desde GitHub
url_luad <- "https://raw.githubusercontent.com/Lamartaav/TESIS/refs/heads/main/tejido_tumoral_LUSC.tsv"
tabla <- read.delim(url_luad, check.names = FALSE)

# Columnas "de paciente"; el resto se asume genes (expresión FPKM-UQ unstranded)
cols_meta  <- c("patient_barcode","submitter_id","Project")
cols_genes <- setdiff(colnames(tabla), cols_meta)

# Asegurar tipo numérico para los genes
X <- tabla[, cols_genes, drop = FALSE] |>
  dplyr::as_tibble() |>
  dplyr::mutate(dplyr::across(dplyr::everything(),
                              ~ suppressWarnings(as.numeric(.x))))


# Por si hay genes con varianza cero (cor() devuelve NA); no los quitamos,
# pero avisamos para interpretación.
genes_var_cero <- names(which(sapply(X, function(v) isTRUE(var(v, na.rm=TRUE) == 0))))
if(length(genes_var_cero)){
  message("Genes con varianza (≈) cero (correlaciones pueden ser NA): ",
          paste(genes_var_cero, collapse = ", "))
}

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Panel 1 (columnas)
panel_1 <- c("SLC2A1","CA9","HIF1A","EPAS1","LDHA","SLC16A1","SLC16A3")
# Panel 2 (columnas)
panel_2 <- c("HK2","PKM2","GPI","ALDOA","PGK1","PGM1","ENO1","CD24")
panel_todos  <- c("SLC2A1","CA9","HIF1A","EPAS1","LDHA","SLC16A1","SLC16A3","HK2","PKM2","GPI","ALDOA","PGK1","PGM1","ENO1","CD24")


presentes <- function(v) intersect(v, colnames(X))
faltan    <- function(v) setdiff(v, colnames(X))

if(length(faltan(panel_1))) message("Panel 1 omitidos (no están en la tabla): ",
                                    paste(faltan(panel_1), collapse=", "))
if(length(faltan(panel_2))) message("Panel 2 omitidos (no están en la tabla): ",
                                    paste(faltan(panel_2), collapse=", "))

panel_1 <- presentes(panel_1)
panel_2 <- presentes(panel_2)

# Filas = TODOS los genes (orden alfabético), en bloques de 10
todos_y <- sort(colnames(X), method = "radix")
chunks_de_10 <- split(todos_y, ceiling(seq_along(todos_y)/10))

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
panel_scatter_r <- function(data, mapping, ...){
  xname <- rlang::as_name(mapping$x)
  yname <- rlang::as_name(mapping$y)
  x <- data[[xname]]
  y <- data[[yname]]

  r <- suppressWarnings(cor(x, y, use = "pairwise.complete.obs", method = "pearson"))
  p <- tryCatch(
    suppressWarnings(cor.test(x, y, method = "pearson")$p.value),
    error = function(e) NA_real_
  )

  stars <- if (is.na(p)) "" else if (p < 0.001) "***" else if (p < 0.01) "**" else if (p < 0.05) "*" else ""

  ggplot(data = data, mapping = mapping) +
    geom_point(alpha = 0.45, size = 0.6) +
    geom_smooth(method = "lm", se = FALSE, linewidth = 0.35) +
    annotate("text",
      x = Inf, y = Inf,
      label = sprintf("r = %.2f%s", r, stars),
      hjust = 1.1, vjust = 1.3, size = 3.2
    )
}

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
plot_bloque <- function(cols_panel, filas_10, titulo){
  # Escalado simple para que quepa todo
  fw <- max(14, 1.6 * length(cols_panel) + 4)
  fh <- max(12, 1.2 * length(filas_10) + 6)
  knitr::opts_current$set(fig.width = fw, fig.height = fh, fig.align = "center")

  g <- GGally::ggduo(
    data = X,
    columnsX = cols_panel,
    columnsY = filas_10,
    types = list(continuous = panel_scatter_r),
    showStrips = TRUE,
    title = titulo
  ) +
    theme_bw(base_size = 9) +
    theme(
      strip.background = element_rect(fill = "grey95"),
      panel.grid.minor = element_blank(),
      plot.title = element_text(hjust = 0.5)
    )
  print(g)
}
```

Regla de estrellitas: * p<0.05, ** p<0.01, *** p<0.001.

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.width=10, fig.height=10, fig.align='center'} 
if(length(panel_1) > 0){
  for(i in seq_along(chunks_de_10)){
    filas <- chunks_de_10[[i]]
    plot_bloque(
      cols_panel = panel_1,
      filas_10   = filas,
      titulo     = sprintf("Correlación (Pearson) — Panel 1 (columnas) vs Bloque %d/%d de genes (filas) | LUAD",
                           i, length(chunks_de_10))
    )
  }
}


```


```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.width=10, fig.height=10, fig.align='center'} 
if(length(panel_2) > 0){
  for(i in seq_along(chunks_de_10)){
    filas <- chunks_de_10[[i]]
    plot_bloque(
      cols_panel = panel_2,
      filas_10   = filas,
      titulo     = sprintf("Correlación (Pearson) — Panel 2 (columnas) vs Bloque %d/%d de genes (filas) | LUAD",
                           i, length(chunks_de_10))
    )
  }
}
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE} 
need(c("pheatmap"))

# (opcional) si no lo tenés ya definido arriba
corr_with_all <- function(v, M){
  n <- colSums(!is.na(M) & !is.na(v))
  r <- suppressWarnings(cor(M, v, use = "pairwise.complete.obs", method = "pearson"))
  p <- rep(NA_real_, length(r))
  ok <- which(n >= 3 & is.finite(r) & abs(r) < 1)
  tval <- r[ok] * sqrt((n[ok]-2) / pmax(1e-12, 1 - r[ok]^2))
  p[ok] <- 2 * pt(-abs(tval), df = n[ok]-2)
  list(r = r, p = p, n = n)
}

# === NUEVA versión: muestra SOLO estrellas ===
heatmap_panel_vs_all <- function(
  X, panel_genes, titulo,
  block_size = 40, log_transform = TRUE,
  save_dir = "/Users/martuvillar/UA/TESIS/PacientesTodos", base_name = "LUSC_Panel_vs_Todos", dpi = 300){panel <- intersect(panel_genes, colnames(X))
  if(length(panel) == 0){ cat("No hay genes del panel presentes en la tabla.\n"); return(invisible(NULL)) }

  M <- X
  M[] <- lapply(M, function(x) suppressWarnings(as.numeric(x)))
  M <- as.matrix(M)
  if (log_transform) M <- log2(1 + M)

  genes_all <- colnames(M)

  R <- matrix(NA_real_, nrow = length(genes_all), ncol = length(panel),
              dimnames = list(genes_all, panel))
  P <- matrix(NA_real_, nrow = length(genes_all), ncol = length(panel),
              dimnames = list(genes_all, panel))

  for (j in seq_along(panel)){
    g <- panel[j]
    res <- corr_with_all(M[, g], M)
    R[, j] <- res$r
    P[, j] <- res$p
  }

  ord <- order(apply(abs(R), 1, max, na.rm = TRUE), decreasing = TRUE)
  R <- R[ord, , drop = FALSE]
  P <- P[ord, , drop = FALSE]

  pal <- colorRampPalette(c("#2166AC","#F7F7F7","#B2182B"))(101)
  nblocks <- ceiling(nrow(R) / block_size)

  for (b in seq_len(nblocks)){
    idx <- (((b-1)*block_size)+1) : min(b*block_size, nrow(R))
    Rb  <- R[idx, , drop = FALSE]
    Pb  <- P[idx, , drop = FALSE]

    # SOLO estrellas (sin r)
    stars <- matrix("", nrow = nrow(Pb), ncol = ncol(Pb), dimnames = dimnames(Pb))
    stars[Pb < 0.001] <- "***"
    stars[Pb >= 0.001 & Pb < 0.01] <- "**"
    stars[Pb >= 0.01  & Pb < 0.05] <- "*"
    numlab <- stars

    fw <- max(7, 1.2 * ncol(Rb) + 4)
    fh <- max(7, 0.35 * nrow(Rb) + 3)
    knitr::opts_current$set(fig.width = fw, fig.height = fh, fig.align = "center")

    pheatmap::pheatmap(
      Rb,
      color = pal,
      breaks = seq(-1, 1, length.out = 101),
      cluster_rows = FALSE,
      cluster_cols = FALSE,
      display_numbers = numlab,       # ← solo estrellas
      number_color = "black",
      fontsize_number = 8.5,
      main = sprintf("%s — \n*** p<0.001  ** p<0.01  * p<0.05", titulo, b, nblocks),
      border_color = "white"
    )
  }
}


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.width=5, fig.height=15, fig.align='center'} 
heatmap_panel_vs_all(
  X,
  panel_genes = panel_1,
  titulo = "LUSC — Pearson: Panel 1 vs Todos",
  block_size = 80,
  save_dir = "/Users/martuvillar/UA/TESIS/PacientesTodos",
  base_name = "LUSC_Panel1_vs_Todos"
)



```


```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.width=5, fig.height=15, fig.align='center'} 
heatmap_panel_vs_all(
  X,
  panel_genes = panel_2,
  titulo = "LUSC — Pearson: Panel 2 vs Todos",
  block_size = 80,
  save_dir = "/Users/martuvillar/UA/TESIS/PacientesTodos",
  base_name = "LUSC_Panel2_vs_Todos"
)

```
```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.width=7, fig.height=12, fig.align='center'} 
heatmap_panel_vs_all(
  X,
  panel_genes = panel_todos,
  titulo = "LUSC — Pearson: Todos",
  block_size = 80,
  save_dir = "/Users/martuvillar/UA/TESIS/PacientesTodos",
  base_name = "LUSC_Panel2_vs_Todos"
)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
options(knitr.kable.NA = '', knitr.kable.format = 'html')
need(c("dplyr","knitr","kableExtra"))
need <- function(pkgs){
  miss <- pkgs[!sapply(pkgs, requireNamespace, quietly = TRUE)]
  if(length(miss)) install.packages(miss)
  invisible(lapply(pkgs, library, character.only = TRUE))
}
need(c("dplyr","knitr","kableExtra"))

# --- utilidades ---
stars_from_p <- function(p){
  ifelse(is.na(p), "",
  ifelse(p < 0.001, "***",
  ifelse(p < 0.01,  "**",
  ifelse(p < 0.05,  "*",  ""))))
}

corr_with_all <- function(v, M){
  n <- colSums(!is.na(M) & !is.na(v))
  r <- suppressWarnings(cor(M, v, use = "pairwise.complete.obs", method = "pearson"))
  p <- rep(NA_real_, length(r))
  ok <- which(n >= 3 & is.finite(r) & abs(r) < 1)
  tval <- r[ok] * sqrt((n[ok]-2) / pmax(1e-12, 1 - r[ok]^2))
  p[ok] <- 2 * pt(-abs(tval), df = n[ok]-2)
  list(r=r, p=p)
}

# --- matriz de expresión (log2(1+FPKM) para ser consistente con tus otros plots) ---
M <- log2(1 + as.matrix(X))

# umbrales (lo que pediste)
r_thr <- 0.20
p_thr <- 0.05  # filtra p > 0.05 (no significativos)

# paneles presentes
p1 <- intersect(panel_1, colnames(M))
p2 <- intersect(panel_2, colnames(M))

make_tables_for_panel <- function(panel_genes, titulo_panel){
  if(length(panel_genes) == 0){
    cat("\n\n###", titulo_panel, "\n\n*No hay genes del panel presentes en la matriz.*\n\n")
    return(invisible(NULL))
  }
  for(g in panel_genes){
    cp <- corr_with_all(M[, g], M)

    tb <- tibble::tibble(
      `Gen (fila)` = colnames(M),
      r             = as.numeric(cp$r),
      p             = as.numeric(cp$p)
    ) |>
      dplyr::filter(`Gen (fila)` != g) |>
      # filtro pedido: |r| ≥ 0.20 y p > 0.05
      dplyr::filter((r >=  r_thr | r <= -r_thr) & p < p_thr) |>
      dplyr::mutate(Significancia = stars_from_p(p)) |>
      dplyr::arrange(dplyr::desc(abs(r))) |>
      dplyr::mutate(r = round(r, 2)) |>
      dplyr::select(`Gen (fila)`, r, Significancia)

    subt <- sprintf("%s — Gen (panel): %s  •  |r| ≥ %.2f  &  p > %.2f", 
                    titulo_panel, g, r_thr, p_thr)

    if(nrow(tb) == 0){
      cat("\n\n", titulo_panel, "—", g, "\n\nNo hay genes que cumplan el filtro.\n\n")
    } else {
      tb |>
        knitr::kable(align = c("l","c","c"), caption = subt) |>
        kableExtra::kable_styling(full_width = FALSE, bootstrap_options = c("striped","hover")) |>
        print()

      pos <- tb |> dplyr::filter(r > 0) |> dplyr::pull(`Gen (fila)`)
      neg <- tb |> dplyr::filter(r < 0) |> dplyr::pull(`Gen (fila)`)

      cat("\nPara el gen ", g, " los genes que se correlacionan positivamente son: ",
          if(length(pos)) paste(pos, collapse = ", ") else "ninguno", "\n\n", sep = "")
      cat("Para el gen ", g, " los genes que se correlacionan negativamente son: ",
          if(length(neg)) paste(neg, collapse = ", ") else "ninguno", "\n\n", sep = "")
    }
  }
}

make_tables_for_panel(p1, "Panel 1")
make_tables_for_panel(p2, "Panel 2")
```
