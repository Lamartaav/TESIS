---
title: "Expresión de Genes: LUAD vs. LUSC"
output: 
  html_document:
    toc: true        # <- Esto activa la tabla de contenido
    toc_depth: 3     # <- Nivel de títulos que se mostrarán (opcional)
    toc_float: false  # <- Hace que el índice flote (opcional)
date: "Índice"
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(survival)
library(survminer)
library(dplyr)
library(tidyverse)
library(ggrepel)
library(scales)
library(ggplot2)
library(plotly)

library(dplyr)
library(tidyr)
library(ggsignif)
library(rstatix)

```

```{r, include=FALSE, cache=TRUE, warning=FALSE}

clinical <- read.delim("https://raw.githubusercontent.com/icassol/TCGA_LUAD/main/clinical.tsv")

exposure <- read.delim("https://raw.githubusercontent.com/icassol/TCGA_LUAD/main/exposure.tsv")

follow_up <- read.delim("https://raw.githubusercontent.com/icassol/TCGA_LUAD/main/follow_up.tsv")

exp_gen_LUAD_LUSC_selected_genes<-read.delim("https://raw.githubusercontent.com/icassol/TCGA_LUAD/main/expr_subset_867patients.tsv")

get(load(url("https://raw.githubusercontent.com/icassol/TCGA_LUAD/main/all_CNV.rda")))
all_CNV<-df_total
rm(df_total)

get(load(url("https://raw.githubusercontent.com/icassol/TCGA_LUAD/main/all_SNV.rda")))
all_SNV<-df_total
rm(df_total)

get(load(url("https://raw.githubusercontent.com/icassol/TCGA_LUAD/main/clinical_supplemental.rda")))
all_clinicall_supp<-data
rm(data)

```

# PARÁMETROS METABÓLICOS

Los boxplots muestran la expresión de los genes de interés relacionados con los parámetros metabólicos a estudiar: SLC2A1 (GLUT1), CA9 (CAIX), HIF1A, EPAS1 (HIF2A), LDHA, MCT1 (SLC16A1), MCT4 (SLC16A3), Hexokinasa (HK2), PKMP2, fosfogluco isomerasa (GPI), aldolasa (ALDOA), fosfoglicerato kinasa 1(PGK1), fosfoglucomutasa 1 (PGM1), enolasa 1 (ENO1), CD274 (PDL1). Se compara la expresión de LUAD con LUSC.

```{r, echo=FALSE, cache=TRUE, warning=FALSE, fig.width=12, fig.height=12}


# Vector de genes de interés
genes_interes <- c("SLC2A1", "CA9", "HIF1A", "EPAS1", "LDHA", 
                   "SLC16A1", "SLC16A3", "HK2", "PKMP2", "GPI", 
                   "ALDOA", "PGK1", "PGM1", "ENO1", "CD274")

# Pacientes LUAD
pacientes_luad <- clinical$cases.submitter_id

# Pasar a formato largo
exp_long <- exp_gen_LUAD_LUSC_selected_genes %>%
  pivot_longer(cols = -c(gene_id, gene_name, gene_type),
               names_to = "paciente", values_to = "expresion") %>%
  mutate(
    paciente_std = gsub("\\.", "-", paciente),
    cohorte = ifelse(paciente_std %in% pacientes_luad, "LUAD", "LUSC")
  ) %>%
  filter(gene_name %in% genes_interes)

# Calcular p-valor por gen y altura del corchete
res_pval <- exp_long %>%
  group_by(gene_name) %>%
  wilcox_test(expresion ~ cohorte) %>%
  mutate(p_text = paste0("p = ", signif(p, 3))) %>%
  left_join(
    exp_long %>% group_by(gene_name) %>%
      summarise(y_position = max(expresion, na.rm = TRUE) * 1.05),
    by = "gene_name"
  ) %>%
  mutate(
    xmin = "LUAD",
    xmax = "LUSC"
  ) %>%
  select(gene_name, xmin, xmax, y_position, annotation = p_text)

# Crear el gráfico base sin la capa manual todavía
p <- ggplot(exp_long, aes(x = cohorte, y = expresion, fill = cohorte)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, alpha = 0.8) +
  geom_jitter(width = 0.2, size = 0.5, alpha = 0.3) +
  facet_wrap(~ gene_name, scales = "free_y", ncol = 5) +
  scale_fill_manual(values = c("LUAD" = "#66c2a5", "LUSC" = "#fc8d62")) +
  theme_minimal(base_size = 11) +
  labs(title = "Expresión génica en LUAD vs LUSC",
       y = "Expresión",
       x = NULL) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


# Agregar capa de corchetes con anotaciones manuales

df_signif <- res_pval %>%
  transmute(
    xmin = "LUAD",
    xmax = "LUSC",
    y_position = y_position,
    annotation = annotation,
    gene_name = gene_name  # <- Debe coincidir con facet_wrap(~ gene_name)
  )

plotfinal<-p + geom_signif(
  data = df_signif,
  inherit.aes = FALSE,
  manual = TRUE,
  aes(xmin = xmin, xmax = xmax, annotations = annotation, y_position = y_position),
  tip_length = 0.01, textsize = 2.5
)


ggsave("boxplots_LUAD_LUSC.jpeg", plot = plotfinal, width = 27, height = 8)
print(plotfinal)
```

# INFILTRADO INMUNE

Los boxplots muestran la expresión de los genes de interés relacionados con el infiltrado inmune a estudiar.

## Macrófagos M1

Genes utilizados: CD80, CD86, HLA-DRA, IL12B, NOS2, TNF, IL1B, CXCL9, CXCL10.

```{r, echo=FALSE, cache=TRUE, warning=FALSE, fig.width=11, fig.height=7}


# Vector de genes de interés
genes_interes <- c("CD80", "CD86", "HLA-DRA", "IL12B", "NOS2", "TNF", "IL1B", "CXCL9", "CXCL10")

# Pacientes LUAD
pacientes_luad <- clinical$cases.submitter_id

# Pasar a formato largo
exp_long <- exp_gen_LUAD_LUSC_selected_genes %>%
  pivot_longer(cols = -c(gene_id, gene_name, gene_type),
               names_to = "paciente", values_to = "expresion") %>%
  mutate(
    paciente_std = gsub("\\.", "-", paciente),
    cohorte = ifelse(paciente_std %in% pacientes_luad, "LUAD", "LUSC")
  ) %>%
  filter(gene_name %in% genes_interes)

# Calcular p-valor por gen y altura del corchete
res_pval <- exp_long %>%
  group_by(gene_name) %>%
  wilcox_test(expresion ~ cohorte) %>%
  mutate(p_text = paste0("p = ", signif(p, 3))) %>%
  left_join(
    exp_long %>% group_by(gene_name) %>%
      summarise(y_position = max(expresion, na.rm = TRUE) * 1.05),
    by = "gene_name"
  ) %>%
  mutate(
    xmin = "LUAD",
    xmax = "LUSC"
  ) %>%
  select(gene_name, xmin, xmax, y_position, annotation = p_text)

# Crear el gráfico base sin la capa manual todavía
p <- ggplot(exp_long, aes(x = cohorte, y = expresion, fill = cohorte)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, alpha = 0.8) +
  geom_jitter(width = 0.2, size = 0.5, alpha = 0.3) +
  facet_wrap(~ gene_name, scales = "free_y", nrow = 1) +
  scale_fill_manual(values = c("LUAD" = "#66c2a5", "LUSC" = "#fc8d62")) +
  theme_minimal(base_size = 11) +
  labs(title = "Expresión génica en LUAD vs LUSC",
       y = "Expresión",
       x = NULL) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


# Agregar capa de corchetes con anotaciones manuales

df_signif <- res_pval %>%
  transmute(
    xmin = "LUAD",
    xmax = "LUSC",
    y_position = y_position,
    annotation = annotation,
    gene_name = gene_name  # <- Debe coincidir con facet_wrap(~ gene_name)
  )

plotfinal<-p + geom_signif(
  data = df_signif,
  inherit.aes = FALSE,
  manual = TRUE,
  aes(xmin = xmin, xmax = xmax, annotations = annotation, y_position = y_position),
  tip_length = 0.01, textsize = 2.5
)


ggsave("boxplots_LUAD_LUSC.jpeg", plot = plotfinal, width = 20, height = 7)
print(plotfinal)
```

## Macfrófagos M2

Genes utilizados: CD163, MRC1, IL10, TGFB1, MMP9, VEGFA, CHI3L1.

```{r, echo=FALSE, cache=FALSE, warning=FALSE, fig.width=8, fig.height=6}


# Vector de genes de interés
genes_interes <- c("CD163", "MRC1", "IL10", "TGFB1", "MMP9", "VEGFA", "CHI3L1")

# Pacientes LUAD
pacientes_luad <- clinical$cases.submitter_id

# Pasar a formato largo
exp_long <- exp_gen_LUAD_LUSC_selected_genes %>%
  pivot_longer(cols = -c(gene_id, gene_name, gene_type),
               names_to = "paciente", values_to = "expresion") %>%
  mutate(
    paciente_std = gsub("\\.", "-", paciente),
    cohorte = ifelse(paciente_std %in% pacientes_luad, "LUAD", "LUSC")
  ) %>%
  filter(gene_name %in% genes_interes)

# Calcular p-valor por gen y altura del corchete
res_pval <- exp_long %>%
  group_by(gene_name) %>%
  wilcox_test(expresion ~ cohorte) %>%
  mutate(p_text = paste0("p = ", signif(p, 3))) %>%
  left_join(
    exp_long %>% group_by(gene_name) %>%
      summarise(y_position = max(expresion, na.rm = TRUE) * 1.05),
    by = "gene_name"
  ) %>%
  mutate(
    xmin = "LUAD",
    xmax = "LUSC"
  ) %>%
  select(gene_name, xmin, xmax, y_position, annotation = p_text)

# Crear el gráfico base sin la capa manual todavía
p <- ggplot(exp_long, aes(x = cohorte, y = expresion, fill = cohorte)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, alpha = 0.8) +
  geom_jitter(width = 0.2, size = 0.5, alpha = 0.3) +
  facet_wrap(~ gene_name, scales = "free_y", nrow = 1) +
  scale_fill_manual(values = c("LUAD" = "#66c2a5", "LUSC" = "#fc8d62")) +
  theme_minimal(base_size = 11) +
  labs(title = "Expresión génica en LUAD vs LUSC",
       y = "Expresión",
       x = NULL) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Agregar capa de corchetes con anotaciones manuales

df_signif <- res_pval %>%
  transmute(
    xmin = "LUAD",
    xmax = "LUSC",
    y_position = y_position,
    annotation = annotation,
    gene_name = gene_name  # <- Debe coincidir con facet_wrap(~ gene_name)
  )

plotfinal<-p + geom_signif(
  data = df_signif,
  inherit.aes = FALSE,
  manual = TRUE,
  aes(xmin = xmin, xmax = xmax, annotations = annotation, y_position = y_position),
  tip_length = 0.01, textsize = 2.5
)


ggsave("boxplots_LUAD_LUSC.jpeg", plot = plotfinal, width = 17, height = 5)
print(plotfinal)
```

## M-MDSC

Genes utilizados: CD14, CD33, ITGAM, IL10, ARG1, NOS2, S100A8, S100A9, STAT3.

```{r, echo=FALSE, cache=FALSE, warning=FALSE, fig.width=9, fig.height=6}


# Vector de genes de interés
genes_interes <- c("CD14", "CD33", "ITGAM", "IL10", "ARG1", "NOS2", "S100A8", "S100A9", "STAT3")

# Pacientes LUAD
pacientes_luad <- clinical$cases.submitter_id

# Pasar a formato largo
exp_long <- exp_gen_LUAD_LUSC_selected_genes %>%
  pivot_longer(cols = -c(gene_id, gene_name, gene_type),
               names_to = "paciente", values_to = "expresion") %>%
  mutate(
    paciente_std = gsub("\\.", "-", paciente),
    cohorte = ifelse(paciente_std %in% pacientes_luad, "LUAD", "LUSC")
  ) %>%
  filter(gene_name %in% genes_interes)

# Calcular p-valor por gen y altura del corchete
res_pval <- exp_long %>%
  group_by(gene_name) %>%
  wilcox_test(expresion ~ cohorte) %>%
  mutate(p_text = paste0("p = ", signif(p, 3))) %>%
  left_join(
    exp_long %>% group_by(gene_name) %>%
      summarise(y_position = max(expresion, na.rm = TRUE) * 1.05),
    by = "gene_name"
  ) %>%
  mutate(
    xmin = "LUAD",
    xmax = "LUSC"
  ) %>%
  select(gene_name, xmin, xmax, y_position, annotation = p_text)

# Crear el gráfico base sin la capa manual todavía
p <- ggplot(exp_long, aes(x = cohorte, y = expresion, fill = cohorte)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, alpha = 0.8) +
  geom_jitter(width = 0.2, size = 0.5, alpha = 0.3) +
  facet_wrap(~ gene_name, scales = "free_y", nrow = 1) +
  scale_fill_manual(values = c("LUAD" = "#66c2a5", "LUSC" = "#fc8d62")) +
  theme_minimal(base_size = 11) +
  labs(title = "Expresión génica en LUAD vs LUSC",
       y = "Expresión",
       x = NULL) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Agregar capa de corchetes con anotaciones manuales

df_signif <- res_pval %>%
  transmute(
    xmin = "LUAD",
    xmax = "LUSC",
    y_position = y_position,
    annotation = annotation,
    gene_name = gene_name  # <- Debe coincidir con facet_wrap(~ gene_name)
  )

plotfinal<-p + geom_signif(
  data = df_signif,
  inherit.aes = FALSE,
  manual = TRUE,
  aes(xmin = xmin, xmax = xmax, annotations = annotation, y_position = y_position),
  tip_length = 0.01, textsize = 2.5
)


ggsave("boxplots_LUAD_LUSC.jpeg", plot = plotfinal, width = 24, height = 7)
print(plotfinal)
```

## PMN-MDSC

Genes utilizados: FUT4, CD33, S100A8, S100A9, ARG1, CYBB.

```{r, echo=FALSE, cache=FALSE, warning=FALSE,fig.width=7, fig.height=6}


# Vector de genes de interés
genes_interes <- c("FUT4", "CD33", "S100A8", "S100A9", "ARG1", "CYBB") 

# Pacientes LUAD
pacientes_luad <- clinical$cases.submitter_id

# Pasar a formato largo
exp_long <- exp_gen_LUAD_LUSC_selected_genes %>%
  pivot_longer(cols = -c(gene_id, gene_name, gene_type),
               names_to = "paciente", values_to = "expresion") %>%
  mutate(
    paciente_std = gsub("\\.", "-", paciente),
    cohorte = ifelse(paciente_std %in% pacientes_luad, "LUAD", "LUSC")
  ) %>%
  filter(gene_name %in% genes_interes)

# Calcular p-valor por gen y altura del corchete
res_pval <- exp_long %>%
  group_by(gene_name) %>%
  wilcox_test(expresion ~ cohorte) %>%
  mutate(p_text = paste0("p = ", signif(p, 3))) %>%
  left_join(
    exp_long %>% group_by(gene_name) %>%
      summarise(y_position = max(expresion, na.rm = TRUE) * 1.05),
    by = "gene_name"
  ) %>%
  mutate(
    xmin = "LUAD",
    xmax = "LUSC"
  ) %>%
  select(gene_name, xmin, xmax, y_position, annotation = p_text)

# Crear el gráfico base sin la capa manual todavía
p <- ggplot(exp_long, aes(x = cohorte, y = expresion, fill = cohorte)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, alpha = 0.8) +
  geom_jitter(width = 0.2, size = 0.5, alpha = 0.3) +
  facet_wrap(~ gene_name, scales = "free_y", nrow = 1) +
  scale_fill_manual(values = c("LUAD" = "#66c2a5", "LUSC" = "#fc8d62")) +
  theme_minimal(base_size = 11) +
  labs(title = "Expresión génica en LUAD vs LUSC",
       y = "Expresión",
       x = NULL) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Agregar capa de corchetes con anotaciones manuales

df_signif <- res_pval %>%
  transmute(
    xmin = "LUAD",
    xmax = "LUSC",
    y_position = y_position,
    annotation = annotation,
    gene_name = gene_name  # <- Debe coincidir con facet_wrap(~ gene_name)
  )

plotfinal<-p + geom_signif(
  data = df_signif,
  inherit.aes = FALSE,
  manual = TRUE,
  aes(xmin = xmin, xmax = xmax, annotations = annotation, y_position = y_position),
  tip_length = 0.01, textsize = 2.5
)


ggsave("boxplots_LUAD_LUSC.jpeg", plot = plotfinal, width = 17, height = 5)
print(plotfinal)
```

## Células NK

Genes utilizados: NCAM1, FCGR3A, KLRK1, NCR1, NCR3, PRF1, GZMB, GZMA, IFNG, KIR2DL1, KIR3DL1.

```{r, echo=FALSE, cache=FALSE, warning=FALSE, fig.width=12, fig.height=9}


# Vector de genes de interés
genes_interes <- c("NCAM1", "FCGR3A", "KLRK1", "NCR1", "NCR3", "PRF1", "GZMB", "GZMA", "IFNG", "KIR2DL1", "KIR3DL1") 

# Pacientes LUAD
pacientes_luad <- clinical$cases.submitter_id

# Pasar a formato largo
exp_long <- exp_gen_LUAD_LUSC_selected_genes %>%
  pivot_longer(cols = -c(gene_id, gene_name, gene_type),
               names_to = "paciente", values_to = "expresion") %>%
  mutate(
    paciente_std = gsub("\\.", "-", paciente),
    cohorte = ifelse(paciente_std %in% pacientes_luad, "LUAD", "LUSC")
  ) %>%
  filter(gene_name %in% genes_interes)

# Calcular p-valor por gen y altura del corchete
res_pval <- exp_long %>%
  group_by(gene_name) %>%
  wilcox_test(expresion ~ cohorte) %>%
  mutate(p_text = paste0("p = ", signif(p, 3))) %>%
  left_join(
    exp_long %>% group_by(gene_name) %>%
      summarise(y_position = max(expresion, na.rm = TRUE) * 1.05),
    by = "gene_name"
  ) %>%
  mutate(
    xmin = "LUAD",
    xmax = "LUSC"
  ) %>%
  select(gene_name, xmin, xmax, y_position, annotation = p_text)

# Crear el gráfico base sin la capa manual todavía
p <- ggplot(exp_long, aes(x = cohorte, y = expresion, fill = cohorte)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, alpha = 0.8) +
  geom_jitter(width = 0.2, size = 0.5, alpha = 0.3) +
  facet_wrap(~ gene_name, scales = "free_y", nrow = 1) +
  scale_fill_manual(values = c("LUAD" = "#66c2a5", "LUSC" = "#fc8d62")) +
  theme_minimal(base_size = 11) +
  labs(title = "Expresión génica en LUAD vs LUSC",
       y = "Expresión",
       x = NULL) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Agregar capa de corchetes con anotaciones manuales

df_signif <- res_pval %>%
  transmute(
    xmin = "LUAD",
    xmax = "LUSC",
    y_position = y_position,
    annotation = annotation,
    gene_name = gene_name  # <- Debe coincidir con facet_wrap(~ gene_name)
  )

plotfinal<-p + geom_signif(
  data = df_signif,
  inherit.aes = FALSE,
  manual = TRUE,
  aes(xmin = xmin, xmax = xmax, annotations = annotation, y_position = y_position),
  tip_length = 0.01, textsize = 2.5
)


ggsave("boxplots_LUAD_LUSC.jpeg", plot = plotfinal, width = 25, height = 8)
print(plotfinal)
```

## Linfocitos T CD8+

Genes utilizados: CD8A, CD8B, PRF1, GZMB, IFNG, TBX21, CXCR3.

```{r, echo=FALSE, cache=FALSE, warning=FALSE, fig.width=9, fig.height=7}


# Vector de genes de interés"
genes_interes <- c("CD8A", "CD8B", "PRF1", "GZMB", "IFNG", "TBX21", "CXCR3") 

# Pacientes LUAD
pacientes_luad <- clinical$cases.submitter_id

# Pasar a formato largo
exp_long <- exp_gen_LUAD_LUSC_selected_genes %>%
  pivot_longer(cols = -c(gene_id, gene_name, gene_type),
               names_to = "paciente", values_to = "expresion") %>%
  mutate(
    paciente_std = gsub("\\.", "-", paciente),
    cohorte = ifelse(paciente_std %in% pacientes_luad, "LUAD", "LUSC")
  ) %>%
  filter(gene_name %in% genes_interes)

# Calcular p-valor por gen y altura del corchete
res_pval <- exp_long %>%
  group_by(gene_name) %>%
  wilcox_test(expresion ~ cohorte) %>%
  mutate(p_text = paste0("p = ", signif(p, 3))) %>%
  left_join(
    exp_long %>% group_by(gene_name) %>%
      summarise(y_position = max(expresion, na.rm = TRUE) * 1.05),
    by = "gene_name"
  ) %>%
  mutate(
    xmin = "LUAD",
    xmax = "LUSC"
  ) %>%
  select(gene_name, xmin, xmax, y_position, annotation = p_text)

# Crear el gráfico base sin la capa manual todavía
p <- ggplot(exp_long, aes(x = cohorte, y = expresion, fill = cohorte)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, alpha = 0.8) +
  geom_jitter(width = 0.2, size = 0.5, alpha = 0.3) +
  facet_wrap(~ gene_name, scales = "free_y", nrow = 1) +
  scale_fill_manual(values = c("LUAD" = "#66c2a5", "LUSC" = "#fc8d62")) +
  theme_minimal(base_size = 11) +
  labs(title = "Expresión génica en LUAD vs LUSC",
       y = "Expresión",
       x = NULL) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Agregar capa de corchetes con anotaciones manuales

df_signif <- res_pval %>%
  transmute(
    xmin = "LUAD",
    xmax = "LUSC",
    y_position = y_position,
    annotation = annotation,
    gene_name = gene_name  # <- Debe coincidir con facet_wrap(~ gene_name)
  )

plotfinal<-p + geom_signif(
  data = df_signif,
  inherit.aes = FALSE,
  manual = TRUE,
  aes(xmin = xmin, xmax = xmax, annotations = annotation, y_position = y_position),
  tip_length = 0.01, textsize = 2.5
)


ggsave("boxplots_LUAD_LUSC.jpeg", plot = plotfinal, width = 17, height = 5)
print(plotfinal)
```

## Linfocitos T CD4+ Th1

Genes utilizados: CD4, TBX21, IFNG, IL2, STAT1.

```{r, echo=FALSE, cache=FALSE, warning=FALSE}


# Vector de genes de interés"
genes_interes <- c("CD4", "TBX21", "IFNG", "IL2", "STAT1") 

# Pacientes LUAD
pacientes_luad <- clinical$cases.submitter_id

# Pasar a formato largo
exp_long <- exp_gen_LUAD_LUSC_selected_genes %>%
  pivot_longer(cols = -c(gene_id, gene_name, gene_type),
               names_to = "paciente", values_to = "expresion") %>%
  mutate(
    paciente_std = gsub("\\.", "-", paciente),
    cohorte = ifelse(paciente_std %in% pacientes_luad, "LUAD", "LUSC")
  ) %>%
  filter(gene_name %in% genes_interes)

# Calcular p-valor por gen y altura del corchete
res_pval <- exp_long %>%
  group_by(gene_name) %>%
  wilcox_test(expresion ~ cohorte) %>%
  mutate(p_text = paste0("p = ", signif(p, 3))) %>%
  left_join(
    exp_long %>% group_by(gene_name) %>%
      summarise(y_position = max(expresion, na.rm = TRUE) * 1.05),
    by = "gene_name"
  ) %>%
  mutate(
    xmin = "LUAD",
    xmax = "LUSC"
  ) %>%
  select(gene_name, xmin, xmax, y_position, annotation = p_text)

# Crear el gráfico base sin la capa manual todavía
p <- ggplot(exp_long, aes(x = cohorte, y = expresion, fill = cohorte)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, alpha = 0.8) +
  geom_jitter(width = 0.2, size = 0.5, alpha = 0.3) +
  facet_wrap(~ gene_name, scales = "free_y", nrow = 1) +
  scale_fill_manual(values = c("LUAD" = "#66c2a5", "LUSC" = "#fc8d62")) +
  theme_minimal(base_size = 11) +
  labs(title = "Expresión génica en LUAD vs LUSC",
       y = "Expresión",
       x = NULL) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Agregar capa de corchetes con anotaciones manuales

df_signif <- res_pval %>%
  transmute(
    xmin = "LUAD",
    xmax = "LUSC",
    y_position = y_position,
    annotation = annotation,
    gene_name = gene_name  # <- Debe coincidir con facet_wrap(~ gene_name)
  )

plotfinal<-p + geom_signif(
  data = df_signif,
  inherit.aes = FALSE,
  manual = TRUE,
  aes(xmin = xmin, xmax = xmax, annotations = annotation, y_position = y_position),
  tip_length = 0.01, textsize = 2.5
)


ggsave("boxplots_LUAD_LUSC.jpeg", plot = plotfinal, width = 19, height = 6)
print(plotfinal)
```

## Linfocitos T CD4+ Th17

Genes utilizados: CD4, RORC, IL17A, IL17F, IL23R.

```{r, echo=FALSE, cache=FALSE, warning=FALSE}


# Vector de genes de interés"
genes_interes <- c("CD4", "RORC", "IL17A", "IL17F", "IL23R") 

# Pacientes LUAD
pacientes_luad <- clinical$cases.submitter_id

# Pasar a formato largo
exp_long <- exp_gen_LUAD_LUSC_selected_genes %>%
  pivot_longer(cols = -c(gene_id, gene_name, gene_type),
               names_to = "paciente", values_to = "expresion") %>%
  mutate(
    paciente_std = gsub("\\.", "-", paciente),
    cohorte = ifelse(paciente_std %in% pacientes_luad, "LUAD", "LUSC")
  ) %>%
  filter(gene_name %in% genes_interes)

# Calcular p-valor por gen y altura del corchete
res_pval <- exp_long %>%
  group_by(gene_name) %>%
  wilcox_test(expresion ~ cohorte) %>%
  mutate(p_text = paste0("p = ", signif(p, 3))) %>%
  left_join(
    exp_long %>% group_by(gene_name) %>%
      summarise(y_position = max(expresion, na.rm = TRUE) * 1.05),
    by = "gene_name"
  ) %>%
  mutate(
    xmin = "LUAD",
    xmax = "LUSC"
  ) %>%
  select(gene_name, xmin, xmax, y_position, annotation = p_text)

# Crear el gráfico base sin la capa manual todavía
p <- ggplot(exp_long, aes(x = cohorte, y = expresion, fill = cohorte)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, alpha = 0.8) +
  geom_jitter(width = 0.2, size = 0.5, alpha = 0.3) +
  facet_wrap(~ gene_name, scales = "free_y", nrow = 1) +
  scale_fill_manual(values = c("LUAD" = "#66c2a5", "LUSC" = "#fc8d62")) +
  theme_minimal(base_size = 11) +
  labs(title = "Expresión génica en LUAD vs LUSC",
       y = "Expresión",
       x = NULL) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Agregar capa de corchetes con anotaciones manuales

df_signif <- res_pval %>%
  transmute(
    xmin = "LUAD",
    xmax = "LUSC",
    y_position = y_position,
    annotation = annotation,
    gene_name = gene_name  # <- Debe coincidir con facet_wrap(~ gene_name)
  )

plotfinal<-p + geom_signif(
  data = df_signif,
  inherit.aes = FALSE,
  manual = TRUE,
  aes(xmin = xmin, xmax = xmax, annotations = annotation, y_position = y_position),
  tip_length = 0.01, textsize = 2.5
)


ggsave("boxplots_LUAD_LUSC.jpeg", plot = plotfinal, width = 17, height = 7)
print(plotfinal)
```

## T reguladores (Tregs)

Genes utilizados: FOXP3, IL2RA (CD25), CTLA4, IKZF2 (Helios), TGFB1, IL10, IL7R.

```{r, echo=FALSE, cache=FALSE, warning=FALSE}


# Vector de genes de interés"
genes_interes <- c("FOXP3", "IL2RA", "CTLA4", "IKZF2", "TGFB1", "IL10",  "IL7R") 

# Pacientes LUAD
pacientes_luad <- clinical$cases.submitter_id

# Pasar a formato largo
exp_long <- exp_gen_LUAD_LUSC_selected_genes %>%
  pivot_longer(cols = -c(gene_id, gene_name, gene_type),
               names_to = "paciente", values_to = "expresion") %>%
  mutate(
    paciente_std = gsub("\\.", "-", paciente),
    cohorte = ifelse(paciente_std %in% pacientes_luad, "LUAD", "LUSC")
  ) %>%
  filter(gene_name %in% genes_interes)

# Calcular p-valor por gen y altura del corchete
res_pval <- exp_long %>%
  group_by(gene_name) %>%
  wilcox_test(expresion ~ cohorte) %>%
  mutate(p_text = paste0("p = ", signif(p, 3))) %>%
  left_join(
    exp_long %>% group_by(gene_name) %>%
      summarise(y_position = max(expresion, na.rm = TRUE) * 1.05),
    by = "gene_name"
  ) %>%
  mutate(
    xmin = "LUAD",
    xmax = "LUSC"
  ) %>%
  select(gene_name, xmin, xmax, y_position, annotation = p_text)

# Crear el gráfico base sin la capa manual todavía
p <- ggplot(exp_long, aes(x = cohorte, y = expresion, fill = cohorte)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, alpha = 0.8) +
  geom_jitter(width = 0.2, size = 0.5, alpha = 0.3) +
  facet_wrap(~ gene_name, scales = "free_y", nrow = 1) +
  scale_fill_manual(values = c("LUAD" = "#66c2a5", "LUSC" = "#fc8d62")) +
  theme_minimal(base_size = 11) +
  labs(title = "Expresión génica en LUAD vs LUSC",
       y = "Expresión",
       x = NULL) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Agregar capa de corchetes con anotaciones manuales

df_signif <- res_pval %>%
  transmute(
    xmin = "LUAD",
    xmax = "LUSC",
    y_position = y_position,
    annotation = annotation,
    gene_name = gene_name  # <- Debe coincidir con facet_wrap(~ gene_name)
  )

plotfinal<-p + geom_signif(
  data = df_signif,
  inherit.aes = FALSE,
  manual = TRUE,
  aes(xmin = xmin, xmax = xmax, annotations = annotation, y_position = y_position),
  tip_length = 0.01, textsize = 2.5
)


ggsave("boxplots_LUAD_LUSC.jpeg", plot = plotfinal, width = 19, height = 7)
print(plotfinal)
```
